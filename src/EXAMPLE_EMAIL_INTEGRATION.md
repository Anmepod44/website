# Email Integration Example

## Complete Example: Add Email Functionality to ResultsStage

### Step 1: Update ResultsStage Component

Add the EmailResultsButton to your ResultsStage component:

```typescript
// components/str8up/ResultsStage.tsx

import { motion } from "motion/react";
import { 
  TrendingDown, 
  Shield, 
  TrendingUp, 
  ArrowRight, 
  CheckCircle2, 
  DollarSign, 
  Clock,
} from "lucide-react";
import { useState, useEffect } from "react";
import type { AnalysisResults, OnboardingFormData } from "../../types/str8up-map.types";
import { generateMockAnalysisResults } from "../../types/str8up-map.types";
import EmailResultsButton from "../EmailResultsButton"; // Add this import

interface ResultsStageProps {
  results?: AnalysisResults;
  formData?: OnboardingFormData;
  onViewCTA: () => void;
}

export default function ResultsStage({ results: providedResults, formData, onViewCTA }: ResultsStageProps) {
  // ... existing code ...

  return (
    <div className="min-h-[calc(100vh-96px)] px-4 py-8">
      <div className="max-w-6xl mx-auto">
        
        {/* ... all your existing content ... */}
        
        {/* Add Email and CTA buttons at the bottom */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.6 }}
          className="flex flex-col md:flex-row items-center justify-center gap-4 mb-8"
        >
          {/* Email Results Button */}
          <EmailResultsButton 
            results={results}
            ctaUrl={`https://zahlentech.com/schedule?session=${results.sessionId}`}
          />
          
          {/* Request Consultation Button */}
          <button
            onClick={onViewCTA}
            className="px-8 py-4 bg-[#FF7800] text-white rounded-full hover:bg-[#E66D00] transition-colors flex items-center gap-2 group"
          >
            Request Detailed Consultation
            <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
          </button>
        </motion.div>
        
        <p className="text-sm text-slate-500 dark:text-slate-500 text-center">
          Our team will reach out within 24 hours
        </p>
      </div>
    </div>
  );
}
```

### Step 2: Backend Email Endpoint

Create an endpoint to handle email sending:

**Python/Flask Example:**

```python
from flask import Flask, request, jsonify
import sendgrid
from sendgrid.helpers.mail import Mail, Email, To, Content

@app.route('/api/str8up/results/<session_id>/email', methods=['POST'])
def email_analysis_results(session_id):
    """Send analysis results via email"""
    try:
        data = request.get_json()
        recipient_email = data['email']
        recipient_name = data.get('recipientName', '')
        
        # Fetch analysis results from database
        results = db.get_analysis_results(session_id)
        
        if not results:
            return jsonify({
                'success': False,
                'message': 'Analysis results not found'
            }), 404
        
        # The HTML and text content should be generated by your email template
        # You can either:
        # 1. Generate it on the backend (recreate the template logic)
        # 2. Accept pre-rendered HTML from frontend
        # 3. Use a template engine like Jinja2
        
        # Option 1: Accept pre-rendered content from frontend
        html_content = generate_email_html(results, recipient_name)
        text_content = generate_email_text(results, recipient_name)
        
        # Send via SendGrid
        sg = sendgrid.SendGridAPIClient(api_key=os.environ.get('SENDGRID_API_KEY'))
        from_email = Email("str8up@zahlentech.com")
        to_email = To(recipient_email)
        subject = f"Your str8up Map Results (Score: {results['meta']['computed_overall_score']}%)"
        
        mail = Mail(from_email, to_email, subject, 
                   plain_text_content=Content("text/plain", text_content),
                   html_content=Content("text/html", html_content))
        
        response = sg.client.mail.send.post(request_body=mail.get())
        
        return jsonify({
            'success': True,
            'message': 'Email sent successfully'
        })
        
    except Exception as e:
        print(f"Error sending email: {str(e)}")
        return jsonify({
            'success': False,
            'message': 'Failed to send email'
        }), 500
```

**Node.js/Express Example:**

```javascript
const express = require('express');
const sgMail = require('@sendgrid/mail');

sgMail.setApiKey(process.env.SENDGRID_API_KEY);

app.post('/api/str8up/results/:sessionId/email', async (req, res) => {
  try {
    const { sessionId } = req.params;
    const { email, recipientName } = req.body;
    
    // Fetch analysis results from database
    const results = await db.getAnalysisResults(sessionId);
    
    if (!results) {
      return res.status(404).json({
        success: false,
        message: 'Analysis results not found'
      });
    }
    
    // Generate email content
    const htmlContent = generateEmailHTML(results, recipientName);
    const textContent = generateEmailText(results, recipientName);
    const subject = `Your str8up Map Results (Score: ${results.meta.computed_overall_score}%)`;
    
    // Send email
    const msg = {
      to: email,
      from: 'str8up@zahlentech.com',
      subject: subject,
      text: textContent,
      html: htmlContent,
    };
    
    await sgMail.send(msg);
    
    res.json({
      success: true,
      message: 'Email sent successfully'
    });
    
  } catch (error) {
    console.error('Error sending email:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to send email'
    });
  }
});
```

### Step 3: Alternative - Send HTML from Frontend

If you want to generate the email HTML on the frontend and send it to your backend:

```typescript
import { 
  generateHTMLEmail, 
  generatePlainTextEmail,
  generateEmailSubject 
} from '../templates/email/analysis-results';
import { apiClient } from '../lib/api-client';

async function sendEmailWithPreRenderedContent(
  sessionId: string,
  email: string,
  name: string,
  results: AnalysisResults
) {
  // Generate email content on frontend
  const htmlContent = generateHTMLEmail({
    recipientName: name,
    recipientEmail: email,
    results: results,
    ctaUrl: `https://zahlentech.com/schedule?session=${sessionId}`
  });
  
  const textContent = generatePlainTextEmail({
    recipientName: name,
    recipientEmail: email,
    results: results,
    ctaUrl: `https://zahlentech.com/schedule?session=${sessionId}`
  });
  
  const subject = generateEmailSubject(results.meta.computed_overall_score);
  
  // Send to backend with pre-rendered content
  const response = await apiClient.post(`/str8up/email/send`, {
    to: email,
    subject: subject,
    html: htmlContent,
    text: textContent
  });
  
  return response;
}
```

**Backend endpoint for pre-rendered content:**

```python
@app.route('/api/str8up/email/send', methods=['POST'])
def send_pre_rendered_email():
    """Send email with pre-rendered HTML content"""
    try:
        data = request.get_json()
        
        sg = sendgrid.SendGridAPIClient(api_key=os.environ.get('SENDGRID_API_KEY'))
        from_email = Email("str8up@zahlentech.com")
        to_email = To(data['to'])
        subject = data['subject']
        
        mail = Mail(
            from_email, 
            to_email, 
            subject,
            plain_text_content=Content("text/plain", data['text']),
            html_content=Content("text/html", data['html'])
        )
        
        response = sg.client.mail.send.post(request_body=mail.get())
        
        return jsonify({
            'success': True,
            'message': 'Email sent successfully'
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': str(e)
        }), 500
```

### Step 4: Test the Integration

1. **Preview the Email**

```typescript
import { previewEmail } from '../services/email.service';
import { generateMockAnalysisResults } from '../types/str8up-map.types';

// Generate mock data
const mockResults = generateMockAnalysisResults({
  businessSize: 'medium',
  cloudProvider: 'aws',
  complexity: 65,
  budget: '100k-500k',
  riskTolerance: 'medium',
  compliance: 'none'
});

// Preview in new window
previewEmail({
  recipientName: 'Test User',
  recipientEmail: 'test@example.com',
  results: mockResults,
  ctaUrl: 'https://zahlentech.com/schedule'
});
```

2. **Send Test Email**

```typescript
import { sendAnalysisResultsEmail } from '../services/email.service';

const response = await sendAnalysisResultsEmail({
  recipientName: 'Test User',
  recipientEmail: 'your-test-email@example.com',
  results: mockResults,
  ctaUrl: 'https://zahlentech.com/schedule'
});

console.log(response); // { success: true, message: '...' }
```

3. **Download Email HTML for Testing**

```typescript
import { downloadEmailHTML } from '../services/email.service';

downloadEmailHTML({
  recipientName: 'Test User',
  recipientEmail: 'test@example.com',
  results: mockResults
}, 'test-email.html');
```

### Step 5: Environment Configuration

Add to `.env`:

```env
# Email Service
VITE_EMAIL_SENDER=str8up@zahlentech.com
VITE_API_BASE_URL=https://api.zahlentech.com

# SendGrid (if using)
SENDGRID_API_KEY=your_sendgrid_api_key

# Mailgun (alternative)
MAILGUN_API_KEY=your_mailgun_api_key
MAILGUN_DOMAIN=mg.zahlentech.com
```

Backend `.env`:

```env
SENDGRID_API_KEY=your_sendgrid_api_key
DATABASE_URL=your_database_url
```

## Email Template Customization

### Change Email Branding

Edit `/templates/email/analysis-results.ts`:

```typescript
// Update sender name in footer
<p style="margin: 0 0 8px 0; color: #ffffff; font-size: 20px;">
  YOUR COMPANY NAME
</p>

// Update company info
<p style="margin: 0; color: #cccccc; font-size: 13px;">
  Your Services | Your Focus | Your Value Prop
</p>
```

### Add Logo Image

```typescript
// In header section, add:
<img 
  src="https://your-cdn.com/logo.png" 
  alt="Company Logo" 
  style="max-width: 200px; height: auto; margin: 0 auto;"
/>
```

### Customize Colors

```typescript
// Primary brand color (green)
const PRIMARY_COLOR = '#009B77';

// Accent color (orange)
const ACCENT_COLOR = '#FF7800';

// Dark background
const DARK_COLOR = '#1C2833';

// Use these throughout the template
```

## Complete Flow Diagram

```
User fills form → Analysis complete → Results displayed
                                              ↓
                                    User clicks "Email Results"
                                              ↓
                                    EmailResultsButton opens
                                              ↓
                                    User enters email/name
                                              ↓
                                    Clicks "Send Email"
                                              ↓
                        Frontend generates HTML/Text content
                                              ↓
                            API call to /api/str8up/email/send
                                              ↓
                            Backend sends via email service
                                              ↓
                                    User receives email
                                              ↓
                            Email contains full analysis report
```

## Production Checklist

- [ ] Configure email service (SendGrid/Mailgun/etc.)
- [ ] Set environment variables
- [ ] Test email delivery to multiple providers
- [ ] Verify email renders correctly on all clients
- [ ] Add unsubscribe link (required for compliance)
- [ ] Set up email monitoring/logging
- [ ] Configure SPF/DKIM records for domain
- [ ] Test with real analysis data
- [ ] Add rate limiting to prevent spam
- [ ] Implement email queue for reliability

The email system is ready to use! Just configure your email service provider and you're good to go.
